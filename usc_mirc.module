<?php
/**
 * @file
 *
 * Module used to house customizations for MIRC@SC.
 *
 */
function usc_mirc_menu() {
  $items = array();
  $items['islandora/object/%islandora_object/preservation-masters'] = array(
    'title' => 'Preservation Masters',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usc_mirc_preservation_masters_form', 2),
    'access callback' => 'usc_mirc_preservation_tab_access',
    'access arguments' => array(2),
  );
  $items['admin/islandora/mirc-usc'] = array(
    'title' => 'MIRC@SC',
    'description' => 'Configure settings for the custom MIRC@SC module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usc_mirc_admin_settings'),
    'access arguments' => array('administer usc_mirc'),
    'file' => 'includes/admin.inc',
  );
  $items['islandora/object/%islandora_object/manage/datastreams/usc-mirc-ingest'] = array(
    'title callback' => 'usc_mirc_retrieve_ingest_title',
    'title arguments' => array(2),
    'access callback' => 'usc_mirc_ingest_access',
    'access arguments' => array(2),
    'type' => MENU_LOCAL_ACTION,
    'page callback' => 'usc_mirc_ingest_page',
    'page arguments' => array(2),
  );
  $items['usc/mezzanine-autocomplete'] = array(
    'page callback' => 'usc_mirc_autocomplete_video_url',
    'page arguments' => array(
      variable_get('usc_mirc_mezzanine_url', '/mnt/mirc/mezz/mezzanine'),
      variable_get('usc_mirc_mezzanine_folder', '/mnt/mirc/mezz/mezzanine'),
      2,
    ),
    'access arguments' => array('administer usc_mirc'),
    'type' => MENU_CALLBACK,
  );
  $items['usc/streaming-autocomplete'] = array(
    'page callback' => 'usc_mirc_autocomplete_video_url',
    'page arguments' => array(
      variable_get('usc_mirc_streaming_url', 'http://dvr-streaming.mirc.sc.edu'),
      variable_get('usc_mirc_streaming_folder', '/mnt/mirc/mezz/access'),
      2,
    ),
    'access arguments' => array('administer usc_mirc'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function usc_mirc_menu_alter(&$items) {
  // Move the manage tab to be the last tab.
  $items['islandora/object/%islandora_object/manage']['weight'] = 10;
}

/**
 * Implements hook_permission().
 */
function usc_mirc_permission() {
  return array(
    'access MIRC@SC tabs' => array(
      'title' => 'access MIRC@SC tabs',
    ),
    'administer usc_mirc' => array(
      'title' => 'Administer the MIRC@SC custom module.',
    ),
  );
}

/**
 * Determines whether the user has access to ingest new objects or not.
 *
 * @param FedoraObject $object
 * @return boolean
 */
function usc_mirc_ingest_access(FedoraObject $object) {
  $usc_models = array('usc:mirc', 'usc:test-mezzanine', 'usc:collectionCModel', 'usc:test-vro');

  if (user_access('administer usc_mirc')) {
    if (array_intersect($usc_models, $object->models) || $object->id === 'usc:mirc') {
      return TRUE;
    }
    else {
      return FALSE;
    }
  }
  else {
    return FALSE;
  }
}

/**
 * Page that loads the required ingest form depending on conditions.
 *
 * @param FedoraObject $object
 * @return type
 */
function usc_mirc_ingest_page(FedoraObject $object) {
  module_load_include('inc', 'islandora', 'includes/utilities');
  module_load_include('inc', 'islandora', 'includes/ingest.form');

  if ($object->id === 'usc:mirc') {
    drupal_set_title(t('Add a new subcollection'));
    return drupal_get_form('islandora_ingest_form', array(
        'namespace' => 'usc-mirc',
        'collections' => array($object->id),
        'models' => array('usc:collectionCModel'),
      )
    );
  }
  elseif (in_array('usc:test-mezzanine', $object->models)) {
    drupal_set_title(t('Add a new access variant'));
    return drupal_get_form('usc_mirc_add_access_variant_form', $object->id);
  }
  elseif (in_array('usc:collectionCModel', $object->models)) {
    drupal_set_title(t('Add a new preservation master'));
    return drupal_get_form('islandora_ingest_form', array(
        'namespace' => 'usc-mirc',
        'collections' => array($object->id),
        'models' => array('usc:test-vro'),
      )
    );
  }
  elseif (in_array('usc:test-vro', $object->models)) {
    drupal_set_title(t('Add a new mezzanine'));
    return drupal_get_form('usc_mirc_add_mezzanine_form', $object->id);
  }
}

/**
 * Title callback for changing the title for the ingest MENU_ACTION_LINK.
 *
 * @param type $object
 * @return type
 */
function usc_mirc_retrieve_ingest_title(FedoraObject $object) {
  if ($object->id === 'usc:mirc') {
    return t('Add a new subcollection');
  }
  elseif (in_array('usc:test-mezzanine', $object->models)) {
    return t('Add a new access variant');
  }
  elseif (in_array('usc:collectionCModel', $object->models)) {
    return t('Add a new preservation master');
  }
  elseif (in_array('usc:test-vro', $object->models)) {
    return t('Add a new mezzanine');
  }
}

/**
 * Determines whether the user has access to the preservation access tab.
 *
 * @param FedoraObject $object
 * @return boolean
 */
function usc_mirc_preservation_tab_access($object) {
  if (in_array('usc:collectionCModel', $object->models)) {
    if (user_access('access MIRC@SC tabs')) {
      return TRUE;
    }
    else {
      return FALSE;
    }
  }
  else {
    return FALSE;
  }
}

/**
 * Implements hook_islandora_xml_form_builder_form_associations().
 */
function usc_mirc_islandora_xml_form_builder_form_associations() {
  return array(
    'usc_root_ingest' => array(
      'content_model' => 'usc:collectionCModel',
      'form_name' => 'Collection Description',
      'dsid' => 'MODS',
      'title_field' => array('title_info', 'title'),
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
    'usc_pbcore_preservation_location' => array(
      'content_model' => 'usc:test-vro',
      'form_name' => 'PBCore Updated Preservation Master Location',
      'dsid' => 'PBCORE',
      'title_field' => array('main_title'),
      'transform' => 'pbcore_to_dc.xsl',
      'template' => FALSE,
    ),
    'usc_pbcore_preservation_description' => array(
      'content_model' => 'usc:test-vro',
      'form_name' => 'PBCore Description Document',
      'dsid' => 'PBCORE',
      'title_field' => array('titles', 'main_title'),
      'transform' => 'pbcore_to_dc.xsl',
      'template' => FALSE,
    ),
  );
}

/**
 * Implements hook_islandora_xml_form_builder_get_transforms().
 */
function usc_mirc_islandora_xml_form_builder_get_transforms() {
  return array(
    'pbcore_to_dc.xslt' => drupal_get_path('module', 'usc_mirc') . '/transforms/pbcore_to_dc.xslt',
  );
}

/**
 * Implements hook_islandora_xml_form_builder_forms().
 */
function usc_mirc_islandora_xml_form_builder_forms() {
  $module_path = drupal_get_path('module', 'usc_mirc');
  return array(
    'Collection Desc Display' => array(
      'form_file' => "$module_path/data/forms/collection_desc_display.xml",
    ),
    'Mezzanine Display' => array(
      'form_file' => "$module_path/data/forms/mezzanine_display.xml",
    ),
    'Short Mezzanine Display' => array(
      'form_file' => "$module_path/data/forms/short_mezzanine_display.xml",
    ),
    'Collection Description' => array(
      'form_file' => "$module_path/data/forms/collection_desc.xml",
    ),
    'PBCore Update Preservation Master Location' => array(
      'form_file' => "$module_path/data/forms/pbcore_master_location.xml",
    ),
    'PBCore Description Document' => array(
      'form_file' => "$module_path/data/forms/pbcore_description.xml",
    ),
  );
}

/**
 * Implements hook_CMODEL_islandora_view_object().
 */
function usc_mirc_usc_test_vro_islandora_view_object($object) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $output = array(
    'metadata' => usc_mirc_metadata_markup($object),
  );
  if (user_access('access MIRC@SC tabs')) {
    $output['mezzanines_list'] = usc_mirc_mezzanines_list($object);
  }
  return array('' => drupal_render($output));
}

/**
 * Implements hook_CMODEL_islandora_view_object().
 */
function usc_mirc_usc_collectionCModel_islandora_view_object($object) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $form = array(
    'collection_metadata' => array(
      '#type' => 'fieldset',
      '#title' => t('Collection Metadata'),
      '#collapsible' => FALSE,
      '#collapsed' => TRUE,
      'usc-collection-image' => array(
        '#prefix' => '<div class="usc-collection-image">',
        '#suffix' => '</div>',
        'image_markup' => array(
          '#markup' => usc_mirc_get_image_markup($object->id, 'Collection image', 'Collection image', 'featured_content_image'),
        ),
      ),

    ),
    'collection_members' => array(
      '#type' => 'fieldset',
      '#title' => t('Collection Members'),
      '#collapsible' => FALSE,
      '#collapsed' => TRUE,
      'members' => usc_mirc_collection_members_markup($object),
    )
  );

  if (isset($object['MODS'])) {
    $mods = $object['MODS']->content;
    $metadata = drupal_get_form('Collection Desc Display', $mods);
    $form['collection_metadata']['MODS_metadata'] = $metadata;
  }
  $output = drupal_render($form);
  return array('' => $output);
}

/**
 * Implements hook_CMODEL_islandora_view_object().
 */
function usc_mirc_usc_test_mezzanine_islandora_view_object($object) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $output = array();
  $output['mezzanine_display'] = array(
    'player' => array(
      '#type' => 'fieldset',
      '#title' => t('Player'),
      '#attributes' => array(
        'class' => array('usc-mirc-fieldset'),
      ),
      'flowplayer_video' => usc_mirc_flowplayer_markup($object),
    ),
    'short_metadata' => array(
      '#type' => 'fieldset',
      '#title' => t('Basic Metadata'),
      '#attributes' => array(
        'class' => array('usc-mirc-fieldset'),
      ),
      'short_metadata' => usc_mirc_metadata_markup($object, TRUE),
    ),
  );

  if (user_access('access MIRC@SC tabs')) {
    $output['mezzanine_display']['access_variant_list'] = usc_mirc_access_variants($object);
  }
  $breadcrumb = array();
  $breadcrumb[] = l(t('Home'), '<front>');
  $breadcrumb[] = l(t('Repository'), 'islandora/object');
  $breadcrumb[] = usc_mirc_build_breadcrumb($object);
  // Add the preservation master breadcrumb if the user has permission
  if (user_access('access MIRC@SC tabs')) {
    $parent_pid = usc_mirc_get_mezzanine_parent($object);
    if ($parent_pid) {
      $parent_object = islandora_object_load($parent_pid);
      $breadcrumb[] = l($parent_object->label, "islandora/object/$parent_pid");
    }
  }
  drupal_set_breadcrumb($breadcrumb);
  return array('' => drupal_render($output));
}

/**
 * Generates the markup for the list of mezzanines.
 *
 * @global type $base_url
 * @param FedoraObject$object
 * @return type
 */
function usc_mirc_mezzanines_list(FedoraObject $object) {
  global $base_url;
  $links = array();
  $mezzanines = usc_mirc_get_derivatives($object);
  foreach ($mezzanines as $mezzanine) {
    $links['usc-mezzanines-' . $mezzanine['subject']['value']] = array(
      'title' => $mezzanine['label']['value'],
      'href' => $base_url . '/islandora/object/' . $mezzanine['subject']['value'],
    );
  }
  $output = array(
    'mezzanines' => array(
      '#type' => 'fieldset',
      '#title' => t('Mezzanines'),
    ),
  );
  if (count($links) > 0) {
    $output['mezzanines']['mezzanines'] = array(
      '#markup' => theme_links(array('links' => $links, 'attributes' => array(), 'heading' => array()))
    );
  }
  else {
    $output['mezzanines']['mezzanines'] = array(
      '#markup' => t('No mezzanines currently present.'),
    );
  }
  return $output;
}

/**
 * Generates the markup for the list of access variants.
 *
 * @global type $base_url
 * @param type $object
 * @return type
 */
function usc_mirc_access_variants($object) {
  global $base_url;
  $links = array();
  $variants = usc_mirc_get_derivatives($object);
  foreach ($variants as $variant) {
    $links['usc-access-variants-' . $variant['subject']['value']] = array(
      'title' => $variant['label']['value'],
      'href' => $base_url . '/islandora/object/' . $variant['subject']['value'],
    );
  }
  $output = array(
    'access_variants' => array(
      '#type' => 'fieldset',
      '#title' => t('Access Variants'),
    ),
  );
  if (count($links) > 0) {
    $output['access_variants']['list_variants'] = array(
      '#markup' => theme_links(array('links' => $links, 'attributes' => array(), 'heading' => array()))
    );
  }
  else {
    $output['access_variants']['list_variants'] = array(
      '#markup' => t('No access variants currently present.'),
    );
  }
  return $output;
}

/**
 * Generates the form for the preservation masters.
 *
 * @param type $form
 * @param type $form_state
 * @param type $object
 * @return type
 */
function usc_mirc_preservation_masters_form($form, &$form_state, $object) {
  $form = array();
  $form['preservation_masters'] = array(
    '#type' => 'fieldset',
    '#title' => t('Collection Members'),
    '#collapsible' => FALSE,
    '#collapsed' => TRUE,
    'members' => usc_mirc_collection_members_markup($object, FALSE),
  );
  $breadcrumb = array();
  $breadcrumb[] = l(t('Home'), '<front>');
  $breadcrumb[] = l(t('Repository'), 'islandora/object');
  drupal_set_breadcrumb($breadcrumb);
  return $form;
}

/**
 * Generates the markup for the collection members.
 *
 * @param type $object
 * @param type $mezzanines
 * @return type
 */
function usc_mirc_collection_members_markup($object, $mezzanines = TRUE) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $markup = array();
  $per_page = variable_get('usc_mirc_number_per_page', '15');
  $current_page = 0;

  if (!empty($_GET['page'])) {
    $current_page = $_GET['page'];
  }
  $child_num = usc_mirc_get_number_of_children($object, $mezzanines);
  $results = usc_mirc_get_collection_set($object, $current_page, $per_page, $mezzanines);
  $table_headers = array(
    t(''),
    t('Thumbnail'),
    t('Info'),
  );
  $table_data = array();
  if ($mezzanines) {
    $field = 'mezzanine';
    $field_title = 'mezzanine_title';
  }
  else {
    $field = 'vro';
    $field_title = 'vro_title';
  }
  foreach ($results as $item) {
    if (!(empty($item[$field]) || empty($item[$field]))) {
      $path = "islandora/object/{$item[$field]['value']}";
      $image = usc_mirc_get_image_markup($item[$field]['value'], $item[$field_title]['value'], $item[$field_title]['value']);
      $table_data[] = array(
        'data' => l($image, $path, array('html' => TRUE, 'attributes' => array('class' => 'item-image-link'))) . l($item[$field_title]['value'], $path, array('attributes' => array('class' => 'item-title-text'))),
        'class' => array('collection-members'),
      );
    }
  }
  if (count($table_data) === 0) {
    $markup['data'] = array(
      '#markup' => t('No public video information in this collection, yet.'),
    );
  }
  else {
    $markup['data'] = array(
      '#markup' => theme('item_list', array('items' => $table_data, 'type' => 'ul', 'attributes' => array(
      'class' => 'usc-collection-view',
    ))));
    pager_default_initialize($child_num, $per_page);
    $markup['pager'] = array(
      '#markup' => theme('pager'),
    );
  }
  return $markup;
}

/**
 * Generates markup for display purposes from a PBCore record.
 *
 * @param type $object
 * @param type $short
 * @return type
 */
function usc_mirc_metadata_markup($object, $short = FALSE) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');

  if ($short) {
    $pbcore_pid = usc_mirc_get_mezzanine_parent($object);
  }
  else {
    $pbcore_pid = $object->id;
  }

  if ($pbcore_pid) {
    if ($short) {
      $pbcore_object = islandora_object_load($pbcore_pid);
    }
    else {
      $pbcore_object = $object;
    }
    if ($pbcore_object['PBCORE']) {
      if ($short) {
        return drupal_get_form('Short Mezzanine Display', $pbcore_object['PBCORE']->content);
      }
      else {
        return drupal_get_form('Mezzanine Display', $pbcore_object['PBCORE']->content);
      }
    }
    else {
      $output = array(
        '#title' => t('Failure!'),
        '#markup' => t('Failed to load the PBCore; Datastream does not exist.')
      );
      return drupal_render($output);
    }
  }
  else {
    $output = array(
      '#title' => t('Failure!'),
      '#markup' => t('Failed to load the PBCore; Unable to retrieve pid of object that contains PBCORE.')
    );
    return drupal_render($output);
  }
}

/**
 * Generates markup for flowplayer.
 *
 * @param type $object
 * @return type
 */
function usc_mirc_flowplayer_markup($object) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $videos = array();
  $derivative_vids = usc_mirc_get_derivatives($object);

  foreach ($derivative_vids as $vid) {
    $pid = $vid['subject']['value'];
    $videos[] = variable_get('islandora_base_url', 'http://localhost:8080/fedora') . "/objects/$pid/datastreams/VIDEO/content";
  }
  return array('#markup' => usc_mirc_mezzanine_player_markup($videos));
}

/**
 * The form for adding a mezzanine.
 *
 * @param type $form
 * @param type $form_state
 * @param type $pid
 * @return type
 */
function usc_mirc_add_mezzanine_form($form, &$form_state, $pid) {
  module_load_include('inc', 'usc_mirc', 'includes/utilities');
  $form = array(
    'parent_pid' => array(
      '#type' => 'hidden',
      '#value' => $pid,
    ),
    'file_name' => array(
      '#type' => 'textfield',
      '#title' => t('Mezzanine file path'),
      '#description' => t('Used to extract technical metadata.'),
      '#autocomplete_path' => 'usc/mezzanine-autocomplete',
      '#weight' => -20,
    ),
    'derivative_type' => usc_mirc_get_mezzanine_types($form_state),
    'derivative_format' => usc_mirc_get_mezzanine_formats($form_state),
    'submit' => array(
      '#type' => 'submit',
      '#value' => t('Ingest'),
    ),
  );
  return $form;
}

/**
 * Validation for the add mezzanine form.
 *
 * @param type $form
 * @param type $form_state
 * @throws Exception
 */
function usc_mirc_add_mezzanine_form_validate($form, &$form_state) {
  $values = $form_state['values'];
  $file = $values['file_name'];
  if (empty($file)) {
    form_set_error('file_name', t('Enter a non-empty path for the file field!'));
  }
  elseif (!(is_file($file) && is_readable($file))) {
    form_set_error('file_name', t('The file %file_name (at %file_path) does not seem to exist or is not readable!', array(
      '%file_path' => $file,
      '%file_name' => isset($form['file_name']['#options']) ? $form['file_name']['#options'][$file] : '',
    )));
  }
  else {
    $old_level = error_reporting(-1);
    try {
      $parent_object = islandora_object_load($values['parent_pid']);
      // Grab media info output for the given file...
      $command = 'mediainfo --Full --Output=XML ' . escapeshellarg($values['file_name']);
      $descriptor = array(
        1 => array('pipe', 'w'),
      );
      $pipes = array();
      $command = escapeshellcmd($command);
      $media_proc = proc_open($command, $descriptor, $pipes);
      $mediainfo_output = '';

      if (!is_resource($media_proc)) {
        form_set_error('file_name', t('Error extracting metadata with Mediainfo!'));
        throw new Exception('Get outta here!');
      }
      else {
        $mediainfo_output = stream_get_contents($pipes[1]);
        fclose($pipes[1]);
        $return_value = proc_close($media_proc);
      }

      $mediainfo_doc = new DOMDocument();
      $mediainfo_doc->loadXML($mediainfo_output);

      if (!$mediainfo_doc) {
        form_set_error('', t('Mediainfo output failed to parse with DOMDocument!'));
        throw new Exception('Get outta here!');
      }

      // Transform the mediainfo file to pbcore
      $pbcore_transform = new DOMDocument();
      $pbcore_transform->load(drupal_get_path('module', 'usc_mirc') . '/transforms/mediainfo_to_pbcoreInstantiation.xsl');

      if ($pbcore_transform === FALSE) {
        watchdog('usc_mirc', 'Failed to load transform!', array(), WATCHDOG_ERROR);
        throw new Exception('Get outta here!');
      }
      $transformer = new XSLTProcessor();
      $transformer->importStylesheet($pbcore_transform);


      $intermediate_pbcore = $transformer->transformToDoc($mediainfo_doc);
      if (!$intermediate_pbcore) {
        form_set_error('', t('Failed transforming Mediainfo XML to PBCore!'));
        throw new Exception('Get outta here!');
      }
      //No longer need this (have the transformed version), free it up.
      unset($mediainfo_doc);

      $pbcore_xpath = new DOMXPath($intermediate_pbcore);
      $pbcore_doc = $pbcore_xpath->document;
      $pbcore_xpath->registerNamespace('pb', 'http://www.pbcore.org/PBCore/PBCoreNamespace.html');

      if (is_callable('taxonomy_get_term')) {
        if ($f = taxonomy_get_term($values['derivative_format'])) {
          $values['derivative_format'] = $f->name;
        }
        if ($t = taxonomy_get_term($values['derivative_type'])) {
          $values['derivative_type'] = $t->name;
        }
      }

      // Add the title, type and format fields
      $title =  $parent_object->label;
      $form_state['storage']['usc_mirc']['title'] = $title;

      $title_el = $pbcore_doc->createElement('instantiationAnnotation', $title);
      $title_el->setAttribute('annotationType', 'instantiation_title');

      foreach ($pbcore_xpath->query('//pb:instantiationEssenceTrack[pb:essenceTrackType/text()="Video"]/pb:essenceTrackFrameSize') as $format_el) {
        $format_el->setAttribute('annotation', $values['derivative_format']);
      }

      $type_el = $pbcore_doc->createElement('instantiationGenerations', $values['derivative_type']);

      $doc_el = $pbcore_doc->documentElement;
      $doc_el->appendChild($title_el);
      $doc_el->appendChild($type_el);

      $pbcore_doc->normalizeDocument();
      $form_state['storage']['usc_mirc']['pbcore'] = $pbcore = $pbcore_doc->saveXML();

      // Create DC transformation of PBCore.
      $dc_transform = new DOMDocument();
      $dc_transform->load(drupal_get_path('module', 'usc_mirc') . '/transforms/pbcore_to_dc.xsl');
      if (!$dc_transform) {
        form_set_error('', t('Failed loading PBCore to DC transform!'));
        throw new Exception('Get outta here!');
      }
      $transformer = new XSLTProcessor();
      $transformer->importStyleSheet($dc_transform);

      $pbcore_doc = new DOMDocument();
      $pbcore_doc->loadXML($pbcore); //XXX:  This seems to be necessary for some reason...  It seems to fail to get the newly added elements for the transform otherwise.  DOMDocument, y u no work!?
      $form_state['storage']['usc_mirc']['dc'] = $dc = $transformer->transformToXML($pbcore_doc);
      if (!$dc) {
        form_set_error('', t('Failed transforming PBCore XML to DC!'));
        throw new Exception('Get outta here!');
      }
      //No longer need this (have it in a string), free it up.
      unset($pbcore_doc);
    }
    catch (Exception $e) {
      //Do nothing...
    }
    error_reporting($old_level);
  }
}

/**
 * Submit handler for the add mezzanine form.
 *
 * @global type $user
 * @param type $form
 * @param type $form_state
 */
function usc_mirc_add_mezzanine_form_submit($form, &$form_state) {
  global $user;

  $values = $form_state['values'];
  $pbcore = $form_state['storage']['usc_mirc']['pbcore'];
  $dc = $form_state['storage']['usc_mirc']['dc'];
  $title = $form_state['storage']['usc_mirc']['title'];

  // If we've properly created the metadata, create the Fedora Object
  if ($pbcore && $dc) {
    $pid_namespace = variable_get('usc_mirc_namespace', 'usc');
    $tuque = islandora_get_tuque_connection();
    $object = $tuque->repository->constructObject($pid_namespace);
    $object->owner = isset($user->name) ? $user->name : $object->owner;
    $object->label = $title;
    $object->relationships->add(FEDORA_RELS_EXT_URI, 'isDerivativeOf', $values['parent_pid']);
    $object->relationships->add(FEDORA_MODEL_URI, 'hasModel', variable_get('usc_mirc_cmodel_mezzanine', 'usc:test-mezzanine'));

    $dc_ds = $object->constructDatastream('DC', 'X');
    $dc_ds->label = 'DC Record';
    $dc_ds->mimetype = 'text/xml';
    $dc_ds->setContentFromString($dc);
    $object->ingestDatastream($dc_ds);

    $pbcore_ds = $object->constructDatastream('PBCORE', 'X');
    $pbcore_ds->label = 'PBCORE Record';
    $pbcore_ds->mimetype = 'text/xml';
    $pbcore_ds->setContentFromString($pbcore);
    $object->ingestDatastream($pbcore_ds);

    islandora_add_object($object);
    $form_state['redirect'] = "islandora/object/$object->id";
  }
  else {
    drupal_set_message(t('PBCore or DC metadata not present!'), 'error');
  }
}

/**
 * The form for adding an access variant.
 *
 * @param array $form
 * @param type $form_state
 * @param type $pid
 * @return array
 */
function usc_mirc_add_access_variant_form($form, &$form_state, $pid) {
  $form = array(
    'parent_pid' => array(
      '#type' => 'hidden',
      '#value' => $pid,
    ),
    'title' => array(
      '#type' => 'textfield',
      '#title' => t('Object label'),
      '#required' => TRUE,
    ),
    'streaming_url' => array(
      '#type' => 'textfield',
      '#title' => t('Streaming URL'),
      '#id' => 'usc-mirc-streaming-url',
      '#required' => TRUE,
      '#autocomplete_path' => 'usc/streaming-autocomplete',
    ),
    'submit' => array(
      '#type' => 'submit',
      '#value' => t('Ingest'),
    )
  );
  return $form;
}

/**
 * Submit handler for the access variant form.
 *
 * @global type $user
 * @param type $form
 * @param array $form_state
 */
function usc_mirc_add_access_variant_form_submit($form, &$form_state) {
  global $user;
  $values = $form_state['values'];
  $pid_namespace = variable_get('usc_mirc_namespace', 'usc');

  $tuque = islandora_get_tuque_connection();
  $object = $tuque->repository->constructObject($pid_namespace);
  $object->owner = isset($user->name) ? $user->name : $object->owner;
  $object->label = $values['title'];
  $video_ds = $object->constructDatastream('VIDEO', 'R');
  $video_ds->label = 'VIDEO';
  $video_ds->mimetype = 'video/mp4';
  $video_ds->url = $values['streaming_url'];
  $object->ingestDatastream($video_ds);
  $object->relationships->add(FEDORA_RELS_EXT_URI, 'isDerivativeOf', $values['parent_pid']);
  $object->relationships->add(FEDORA_MODEL_URI, 'hasModel', variable_get('usc_mirc_cmodel_access', 'usc:test-access'));
  islandora_add_object($object);
  $form_state['redirect'] = "islandora/object/$object->id";
}

/**
 * Autocomplete callback used to obtain streaming URLs.
 */
function usc_mirc_autocomplete_video_url($url_base, $filesystem_base, $string) {
  module_load_include('inc', 'usc_mirc', 'includes/autocomplete');

  $videos = usc_mirc_traverse_directory($url_base, $filesystem_base, $string);
  $videos = array_filter($videos, 'usc_mirc_is_video_filename');

  ksort($videos);
  drupal_json_output($videos);
}